<?php
// Hacked version of master - replace with refactored branch for 0.2

/**
 * @file
 * Code for the Kendra Social Services feature.
 */

include_once DRUPAL_ROOT . '/' . drupal_get_path('module', 'kendra_social_services') . '/kendra_social_services.features.inc';
include_once DRUPAL_ROOT . '/' . drupal_get_path('module', 'kendra_social_services') . '/kendra_social_services.resources.inc';
include_once DRUPAL_ROOT . '/' . drupal_get_path('module', 'kendra_social_services') . '/kendra_social_services.callbacks.inc';

// This function adds the recommender word cloud into user profiles when loading them
function kendra_social_services_user_load($users) {
  $recommendation = db_query("SELECT * FROM {kendra_match_recommender_out_tags} t WHERE t.uid IN (:uids)", array(':uids' => array_keys($users)));
  foreach ($recommendation as $record) {
    $users[$record->uid]->profile_tags[] = array('name' => $record->tag, 'score' => $record->weight, 'type' => 'explicit');
  }
  $fb_users = db_query("SELECT u.uid, u.fbu, a.session_key FROM {fb_user_app} a INNER JOIN {fb_user} u ON a.fbu = u.fbu WHERE uid IN (:uids)",
    array(':uids' => array_keys($users))
  );
  foreach ($fb_users as $fbuser) {
    $users[$fbuser->uid]->fbu = $fbuser->fbu;
    $users[$fbuser->uid]->key = $fbuser->session_key;
    $queue = DrupalQueue::get('kendra_saracen_trial');
    $item = new stdClass();
    $item->type = 'facebook_profile';
    $item->uid = $fbuser->uid;
    $item->fbu = $fbuser->fbu;
    $item->access_token = $fbuser->session_key;
    $queue->createItem($item);
  }
  // DEBUG: load fb likes for this user into profile
  $fblikes = db_query("SELECT * FROM {sparql_store_fblike_temp} f WHERE f.uid IN (:uids)", array(':uids' => array_keys($users)));
  foreach ($fblikes as $like) {
    $users[$like->uid]->{$like->connection}[] = $like->name;
  }
  if (TRUE) { // set to false to debug friends
	  foreach ($users as $account) {
		  $users[$account->uid]->saracen_friends = array();
		  //used for live debugging: if ($account->uid == 27) {
			if (isset($account->fbu) && isset($account->key)) {
				$friends = _kendra_saracen_get_facebook_friends($account, $account->fbu, $account->key);
				$users[$account->uid]->facebook_friends = array();
				if (is_array($friends)) {
					foreach ($friends as $friend) {
						$users[$account->uid]->facebook_friends[$friend->id] = $friend->name;
					}
					if (!empty($users[$account->uid]->facebook_friends)) {
					  $saracen_friends = db_query("SELECT u.uid, u.fbu FROM {fb_user} u WHERE fbu IN (:fbuids)",
					    array(':fbuids' => array_keys($users[$account->uid]->facebook_friends))
					  );
					  foreach ($saracen_friends as $sfriend) {
						  //$friend_account = user_load($sfriend->uid);
							$users[$account->uid]->saracen_friends[$sfriend->uid] = (object) array(
								'id' => $sfriend->uid,
								'name' => $users[$account->uid]->facebook_friends[$sfriend->fbu],
								'sources' => array('facebook'),
							);
						}
					}
					// TODO: remove fb friends, daniel wants this in here for now:
					//unset($users[$account->uid]->facebook_friends);
				} else {
					$users[$account->uid]->facebook_friends = $friends;
				}
		//}
		  }
		  if ($twitter_active) {
			  static $twitter_lists;
			  if (!isset($twitter_lists[$account->uid])) {
  				$twitter_uid = db_query("SELECT twitter_uid FROM {twitter_account} WHERE uid = :uid", array(':uid' => $account->uid))->fetchField();
	  			if (!empty($twitter_uid)) {
		  		  module_load_include('inc', 'twitter');
  		  	  $twitter_account = twitter_account_load($twitter_uid);
					  $auth = $twitter_account->get_auth();
	  		    $twitter = new TwitterOAuth(
	    				variable_get('twitter_consumer_key', ''), variable_get('twitter_consumer_secret', ''), 
							$auth['oauth_token'], $auth['oauth_token_secret']);
	          $params = array('screen_name' => $twitter_account->screen_name);
						$url = 'http://api.twitter.com/1/friends/ids.json';
		  		  //$twitter_lists[$account->uid] = '<pre>' . print_r($twitter, TRUE) . '</pre>';
		        $twitter_result = $twitter->auth_request($url, $params, 'GET');
						$twitter_lists[$account->uid] = json_decode($twitter_result);
		        //$twitter_lists[$account->uid] = $twitter->call('friends/ids', $params, 'GET');
		  		  //$users[$account->uid]->twitter_verify = $twitter->verify_credentials();
		  		  //$users[$account->uid]->twitter_auth = $auth;
		      } else {
						$twitter_lists[$account->uid] = array();
					}
			  }
			  if (isset($twitter_lists[$account->uid]->ids)) { 
  			  $users[$account->uid]->twitter_friends = $twitter_lists[$account->uid]->ids;        
				  $saracen_friends = db_query("SELECT t.twitter_uid, t.uid FROM {twitter_account} t WHERE t.twitter_uid IN (:tuids)",
				    array(':tuids' => $users[$account->uid]->twitter_friends)
				  );
					static $twitter_names;
					// TODO: more robust method of looking up twitter friend names
					if ($account->uid == 27) { 
					  $url = 'http://api.twitter.com/1/users/lookup.json';
					  $params = array('user_id' => implode(',', array_slice($twitter_lists[$account->uid]->ids, 0, 100)));
						try {
							$twitter_debug = json_decode($twitter->auth_request($url, $params, 'POST'));
							if (is_array($twitter_debug)) {
								foreach ($twitter_debug as $twit) {
									$twitter_names[$twit->id] = $twit->screen_name;
								}
							}
						} catch (Exception $e) {
							$users[$account->uid]->twitter_debug = $e->__toString();
						}
					}
				  foreach ($saracen_friends as $sfriend) {
					  if (isset($users[$account->uid]->saracen_friends[$sfriend->uid])) {
						  $users[$account->uid]->saracen_friends[$sfriend->uid]->sources[] = 'twitter';
						} else {
							if (!isset($twitter_names[$sfriend->twitter_uid])) {
							  $users[$account->uid]->saracen_friends[$sfriend->uid]->twitter_name = $twitter_names[$sfriend->twitter_uid];
								//$twitter_names[$sfriend->twitter_uid] = !empty($twitname) ? $twitname : 'unknown';
							}
							$users[$account->uid]->saracen_friends[$sfriend->uid] = (object) array(
								'id' => $sfriend->uid,
								'name' => isset($twitter_names[$sfriend->twitter_uid]) ? $twitter_names[$sfriend->twitter_uid] : 'unknown',
								'sources' => array('twitter'),
							);
						}
				  }
        }
	    }
	    
	  } 
  }
  foreach ($users as $uid => $account) {
	  $users[$account->uid]->saracen_friends = (array) $users[$account->uid]->saracen_friends;
	  foreach ((array)$users[$uid]->saracen_friends as $fid => $friend) {
		  $users[$uid]->saracen_friends[$fid]->boxes = _kendra_social_albums_index_fetch($fid);
	  }
  }
  foreach ($users as $uid => $account) {
	  $users[$uid]->boxes = _kendra_social_albums_index_fetch($account);
  }
}

// old hacked version of user profile load hook
function kendra_social_services_user_load_noqueue($users) {
  $recommend = db_query("SELECT * FROM {kendra_match_recommender_out_tags} t WHERE t.uid IN (:uids)",
    array(':uids' => array_keys($users))
  );
  foreach ($recommend as $record) {
    $users[$record->uid]->profile_tags[] = array('name' => $record->tag, 'score' => $record->weight,
      'type' => 'explicit',
    );
  }
  $result = db_query('SELECT u.uid, u.fbu, a.session_key FROM {fb_user_app} a INNER JOIN {fb_user} u ON a.fbu = u.fbu WHERE uid IN (:uids)',
    array(':uids' => array_keys($users))
  );
  foreach ($result as $record) {
    $users[$record->uid]->fbu = $record->fbu;
    //$users[$record->uid]->access_token = $record->session_key;
    $connections = array('likes', 'movies', 'music');
    $first = TRUE;
    foreach ($connections as $connection) {
      $test = drupal_http_request('https://graph.facebook.com/' . $record->fbu . '/' . $connection . '?access_token=' . $record->session_key);
      if ($test->code == 200) {
        $data = json_decode($test->data);
        foreach ($data->data as $like) {
          $key = "fb_{$connection}";
          $users[$record->uid]->{$key}[] = $like->name;
          if ($first) {
            // if first, drop all profile tags from recommender input
            _kendra_saracen_save_recommend($record->uid, NULL, 'profile', $like->name, TRUE, $like->id);
          }
          else {
            _kendra_saracen_save_recommend($record->uid, NULL, 'profile', $like->name, FALSE, $like->id);
          }
          $first = FALSE;
          _kendra_saracen_sparql_util('userFb', $key, url('user/' . $record->uid, array('absolute' => TRUE)), $users[$record->uid]->{$key});
        }
      }
      else {
        if (isset($test->data)) {
          $data = json_decode($test->data);
          $users[$record->uid]->fb_error[$connection] = $data->error->message;
          // $users[$record->uid]->fb_error_debug[$connection] = print_r($test, TRUE);
        }
        else {
          $users[$record->uid]->fb_error[$connection] = print_r($test, TRUE);
        }
      }
    }
  }
}

function kendra_social_services_permission() {
  return array(
    'access kendra social connect' => array(
      'title' => t('Access Kendra Social Connect services'),
      'description' => t('Perform social connect operations via the API'),
    ),
  );
}

/**
 * Implementation of hook_services_resources().
 */
function kendra_social_services_services_resources() {
  $resources = kendra_social_services_services_get_mappings();
  return $resources;
}

function _kendra_social_services_user_retrieve_access_check($op = 'view', $args = array()) {
    return TRUE;
  if ($args[0] == '@me') {
    return TRUE;
  }
  else {
    return _user_resource_access($op, $args);
  }
}

function _kendra_social_services_user_retrieve_callback($uid) {
  if ($uid == '@me') {
    global $user;
    $uid = $user->uid;
  }
  return _user_resource_retrieve($uid);
}


<?php
/**
 * @file
 * Code for the Kendra Social Services feature.
 */

include_once('kendra_social_services.features.inc');
include_once('kendra_social_services.resources.inc');

function _kss_social_default_callback() {
	return "Kendra Social default callback";
}

function kendra_social_services_permission() {
  return array(
    'access kendra social connect' => array(
      'title' => t('Access Kendra Social Connect services'), 
      'description' => t('Perform social connect operations via the API'),
    ),
  );
}

/**
 * Implementation of hook_services_resources().
 */
function kendra_social_services_services_resources() {
	$resources = kendra_social_services_services_get_mappings();
	return $resources;
}

function _kss_social_profile_test($id) {
	return "Profile information for $id";
}

function _kss_social_publish($domain, $msg) {
	if ($domain == 'facebook.com') {
		$fbid = db_query("SELECT fbu FROM {fb_user} WHERE uid = :uid",
		array(':uid' => $user->uid))->fetchField();
		$access_token = db_query("SELECT session_key FROM {fb_user_app} WHERE fbu = :fbu",
		array(':fbu' => $fbid))->fetchField();
		$fb_feed_url = "https://graph.facebook.com/$fbid/feed";

		$result = drupal_http_request($fb_feed_url, array(
		  'method' => 'POST',
		  'data' => "access_token={$access_token}&message={$msg}",
		));

		//watchdog('kss_social_publish', print_r($result, TRUE));
		return $result->status_message;
	} else {
		return "Unknown domain";
	}
}

function _kss_social_connect($domain) {
	if ($domain == 'facebook.com') {
		$connect_url = url('connect', array('absolute' => TRUE));
		return array(
      'embed' => "<iframe src=\"{$connect_url}\" width=\"300px\" height=\"400px\" />",
		);
	}
	return "Kendra Social connect error: domain unknown";
}

/**
 * Define a callback that displays the registration/connect form
 */
function kendra_social_services_menu() {
	$items = array();
	$items['connect'] = array(
    'title' => 'Connect',
    'page callback' => '_kendra_social_services_connect',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
	);
	return $items;
}
function _kendra_social_services_connect() {
	return "<fb:login-button scope=\"\" v=\"2\">Connect</fb:login-button>";
	//$form = drupal_get_form('user_register_form');
	//print drupal_render($form);
}

